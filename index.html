<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR코드 제작 (중앙 로고)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      max-width: 560px;
      margin: 0 auto;
      padding: 24px;
      background: #f5f5f5;
      min-height: 100vh;
    }
    h1 {
      font-size: 1.5rem;
      color: #333;
      margin: 0 0 8px 0;
    }
    .sub {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 24px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .card h2 {
      font-size: 0.95rem;
      color: #444;
      margin: 0 0 12px 0;
      font-weight: 600;
    }
    label { display: block; font-size: 0.85rem; color: #555; margin-bottom: 6px; }
    input[type="text"],
    input[type="url"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 10px;
    }
    input[type="text"]:focus,
    input[type="url"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    }
    input[type="file"] {
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    .url-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .url-row input { flex: 1; margin-bottom: 0; }
    .url-row .remove {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #6b7280;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
    }
    .url-row .remove:hover { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-add {
      background: #f1f5f9;
      color: #475569;
      border: 1px dashed #cbd5e1;
    }
    .btn-add:hover { background: #e2e8f0; }
    .btn-add:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-gen {
      background: #2563eb;
      color: #fff;
      width: 100%;
      padding: 14px;
      font-size: 1rem;
    }
    .btn-gen:hover { background: #1d4ed8; }
    .btn-gen:disabled { background: #93c5fd; cursor: not-allowed; }
    .preview-img {
      max-width: 120px;
      max-height: 120px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .count {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 8px;
    }
    #log {
      margin-top: 16px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #334155;
      min-height: 48px;
    }
    .err { color: #dc2626; }
    .ok { color: #059669; }
  </style>
</head>
<body>
  <h1>QR코드 제작</h1>
  <p class="sub">링크를 입력하고 중앙에 넣을 이미지를 선택한 뒤 생성하세요.</p>

  <div class="card">
    <h2>중앙에 넣을 이미지 (로고)</h2>
    <label>이미지 선택 (QR 중앙에 배치, 배경은 흰색 처리)</label>
    <input type="file" id="logoFile" accept="image/*">
    <div id="logoPreview"></div>
  </div>

  <div class="card">
    <h2>링크 목록</h2>
    <label>URL 또는 텍스트 (복사·붙여넣기 가능)</label>
    <div id="urlList"></div>
    <button type="button" class="btn btn-add" id="btnAdd">+ 추가</button>
    <p class="count" id="urlCount">1개 입력 중 (최대 10개)</p>
  </div>

  <div class="card">
    <button type="button" class="btn btn-gen" id="btnGen">QR코드 생성 후 폴더에 저장</button>
    <div id="log"></div>
  </div>

  <script>
    (function () {
      const MAX_URLS = 10;
      const QR_SIZE = 400;
      const LOGO_RATIO = 0.24;

      let logoImage = null;
      let QRLib = null;
      const urlListEl = document.getElementById('urlList');
      const btnAdd = document.getElementById('btnAdd');
      const btnGen = document.getElementById('btnGen');
      const urlCountEl = document.getElementById('urlCount');
      const logEl = document.getElementById('log');
      const logoFile = document.getElementById('logoFile');
      const logoPreview = document.getElementById('logoPreview');

      function makeDavidshimjsWrapper() {
        var QRCode = window.QRCode;
        if (!QRCode || typeof QRCode !== 'function') return null;
        if (typeof QRCode.prototype.makeCode !== 'function') return null;
        var CorrectLevel = QRCode.CorrectLevel || { L: 0, M: 1, Q: 2, H: 3 };
        var level = (typeof CorrectLevel.H === 'number') ? CorrectLevel.H : 2;
        return {
          toCanvas: function (canvas, text, options, callback) {
            try {
              var size = (options && options.width) || 256;
              var div = document.createElement('div');
              div.style.cssText = 'width:' + size + 'px;height:' + size + 'px;position:absolute;left:-9999px;top:0';
              document.body.appendChild(div);
              new QRCode(div, { text: text, width: size, height: size, correctLevel: level });
              var qrCanvas = div.querySelector('canvas');
              if (!qrCanvas) {
                if (div.parentNode) div.parentNode.removeChild(div);
                return callback(new Error('QR canvas not created'));
              }
              var ctx = canvas.getContext('2d');
              canvas.width = size;
              canvas.height = size;
              ctx.drawImage(qrCanvas, 0, 0);
              if (div.parentNode) div.parentNode.removeChild(div);
              callback(null);
            } catch (e) {
              callback(e);
            }
          }
        };
      }

      function getQRLib() {
        var w = window;
        var cand = [w.qrcode, w.QRCode];
        for (var i = 0; i < cand.length; i++) {
          if (cand[i] && typeof cand[i].toCanvas === 'function') return cand[i];
          if (cand[i] && cand[i].default && typeof cand[i].default.toCanvas === 'function') return cand[i].default;
        }
        var wrapper = makeDavidshimjsWrapper();
        if (wrapper && typeof wrapper.toCanvas === 'function') return wrapper;
        return null;
      }

      function setLog(msg, isErr) {
        logEl.innerHTML = '<span class="' + (isErr ? 'err' : 'ok') + '">' + msg + '</span>';
      }

      function loadScript(src) {
        return new Promise(function (resolve, reject) {
          var s = document.createElement('script');
          s.src = src;
          s.onload = function () { resolve(); };
          s.onerror = function () { reject(new Error('로드 실패: ' + src)); };
          document.head.appendChild(s);
        });
      }

      function tryInit() {
        QRLib = getQRLib();
        if (QRLib && typeof QRLib.toCanvas === 'function') {
          setLog('QR 라이브러리 사용 가능. 링크 입력 후 [생성]을 누르세요.', false);
          return true;
        }
        return false;
      }

      function runAfterLibraryReady() {
        if (tryInit()) return;
        setLog('라이브러리 로딩 중…', false);
        var cdns = [
          'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
          'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
          'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js'
        ];
        var idx = 0;
        function next() {
          if (tryInit()) return;
          if (idx >= cdns.length) {
            setLog('QR 라이브러리를 불러올 수 없습니다. 인터넷 연결을 확인하거나 다른 브라우저(Chrome/Edge)로 시도하세요.', true);
            return;
          }
          loadScript(cdns[idx])
            .then(function () {
              if (!tryInit()) { idx++; next(); }
            })
            .catch(function () {
              idx++;
              next();
            });
        }
        next();
      }

      function startApp() {
      function addUrlRow(value, canRemove) {
        value = value || '';
        canRemove = !!canRemove;
        const row = document.createElement('div');
        row.className = 'url-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'https://example.com 또는 입력할 텍스트';
        input.value = value;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn remove';
        removeBtn.textContent = '×';
        removeBtn.title = '삭제';
        if (!canRemove) removeBtn.style.visibility = 'hidden';
        removeBtn.addEventListener('click', function () {
          row.remove();
          updateCount();
        });
        row.appendChild(input);
        row.appendChild(removeBtn);
        urlListEl.appendChild(row);
        return row;
      }

      function updateCount() {
        const n = urlListEl.querySelectorAll('.url-row').length;
        urlCountEl.textContent = n + '개 입력 중 (최대 10개)';
        btnAdd.disabled = n >= MAX_URLS;
        if (n < MAX_URLS) btnAdd.disabled = false;
        urlListEl.querySelectorAll('.remove').forEach((btn, i) => {
          btn.style.visibility = n > 1 ? 'visible' : 'hidden';
        });
      }

      addUrlRow('', false);
      updateCount();
      btnAdd.disabled = false;

      btnAdd.addEventListener('click', function () {
        if (urlListEl.querySelectorAll('.url-row').length >= MAX_URLS) return;
        addUrlRow('', true);
        updateCount();
      });

      logoFile.addEventListener('change', function (e) {
        const file = e.target.files[0];
        logoPreview.innerHTML = '';
        logoImage = null;
        if (!file || !file.type.startsWith('image/')) return;
        const img = new Image();
        img.onload = function () {
          logoImage = img;
          const thumb = document.createElement('img');
          thumb.className = 'preview-img';
          thumb.src = img.src;
          logoPreview.appendChild(thumb);
        };
        img.src = URL.createObjectURL(file);
      });

      function drawQrWithLogo(canvas, text, logoImg, size) {
        return new Promise(function (resolve, reject) {
          const ctx = canvas.getContext('2d');
          canvas.width = size;
          canvas.height = size;

          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = size;
          tempCanvas.height = size;

          const opt = { errorCorrectionLevel: 'H', width: size, margin: 1 };
          QRLib.toCanvas(tempCanvas, text, opt, function (err) {
            if (err) return reject(err);
            ctx.drawImage(tempCanvas, 0, 0);

            const pad = Math.floor(size * 0.02);
            const inner = size - pad * 2;
            const logoSize = Math.floor(inner * LOGO_RATIO);
            const x0 = pad + (inner - logoSize) / 2;
            const y0 = pad + (inner - logoSize) / 2;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x0 - 2, y0 - 2, logoSize + 4, logoSize + 4);

            if (logoImg && logoImg.complete && logoImg.naturalWidth) {
              const imgSize = Math.floor(logoSize * 0.85);
              const xi = x0 + (logoSize - imgSize) / 2;
              const yi = y0 + (logoSize - imgSize) / 2;
              ctx.drawImage(logoImg, xi, yi, imgSize, imgSize);
            }
            resolve();
          });
        });
      }

      function getUrls() {
        const inputs = urlListEl.querySelectorAll('.url-row input');
        const list = [];
        inputs.forEach(function (inp) {
          const v = (inp.value || '').trim();
          if (v) list.push(v);
        });
        return list;
      }

      function log(msg, isErr) {
        logEl.innerHTML = '<span class="' + (isErr ? 'err' : 'ok') + '">' + msg + '</span>';
      }

      function downloadBlob(blob, filename) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      btnGen.addEventListener('click', async function () {
        const urls = getUrls();
        if (urls.length === 0) {
          log('링크를 1개 이상 입력해 주세요.', true);
          return;
        }
        if (!QRLib || typeof QRLib.toCanvas !== 'function') {
          log('QR 라이브러리를 사용할 수 없습니다. 페이지를 새로고침 해보세요.', true);
          return;
        }

        const useFolderPicker = typeof window.showDirectoryPicker === 'function';
        let dirHandle = null;
        if (useFolderPicker) {
          try {
            dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
          } catch (e) {
            if (e.name === 'AbortError') {
              log('폴더 선택이 취소되었습니다.');
              return;
            }
            dirHandle = null;
          }
        }

        btnGen.disabled = true;
        log('생성 중...');

        const canvas = document.createElement('canvas');
        let done = 0;

        for (let i = 0; i < urls.length; i++) {
          const text = urls[i];
          try {
            await drawQrWithLogo(canvas, text, logoImage, QR_SIZE);
            const blob = await new Promise(function (res) {
              canvas.toBlob(res, 'image/png', 1);
            });
            const safeName = (text.replace(/[^a-zA-Z0-9가-힣\-_.]/g, '_').slice(0, 80) || 'qr') + '_' + (i + 1) + '.png';

            if (dirHandle) {
              const fileHandle = await dirHandle.getFileHandle(safeName, { create: true });
              const w = await fileHandle.createWritable();
              await w.write(blob);
              await w.close();
            } else {
              downloadBlob(blob, safeName);
            }
            done++;
          } catch (e) {
            console.error(e);
            log('저장 중 오류: ' + (e.message || e), true);
            btnGen.disabled = false;
            return;
          }
        }

        if (dirHandle) {
          log('총 ' + done + '개 QR코드를 선택한 폴더에 저장했습니다.');
        } else {
          log('총 ' + done + '개 QR코드를 다운로드했습니다. (폴더 저장은 Chrome/Edge에서만 가능)');
        }
        btnGen.disabled = false;
      });
      }

      function onReady() {
        startApp();
        runAfterLibraryReady();
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', onReady);
      } else {
        onReady();
      }
    })();
  </script>
</body>
</html>
